services:
  oracle-db:
    image: gvenzl/oracle-xe:latest
    container_name: oracle-db
    environment:
      ORACLE_PASSWORD: ${ORACLE_PASSWORD}
      ORACLE_DATABASE: XEPDB1
    ports:
      - "1521:1521"
    volumes:
      - ./oracle-init/init.sql:/container-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD", "healthcheck.sh"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 120s
    networks:
      - oracle-demo

  oracle-otel-exporter:
    image: container-registry.oracle.com/database/observability-exporter:2.2.1
    container_name: oracle-otel-exporter
    volumes:
      - ./exporter/config.yaml:/config.yaml
    command: ["--config.file=/config.yaml"]
    ports:
      - "19161:9161"
    depends_on:
      oracle-db:
        condition: service_healthy
    networks:
      - oracle-demo

  grafana-alloy:
    image: grafana/alloy:v1.8.2
    container_name: grafana-alloy
    environment:
      GRAFANA_CLOUD_METRICS_URL: ${GRAFANA_CLOUD_METRICS_URL}
      GRAFANA_CLOUD_METRICS_USERNAME: ${GRAFANA_CLOUD_METRICS_USERNAME}
      GRAFANA_CLOUD_API_KEY: ${GRAFANA_CLOUD_API_KEY}
    ports:
      - "12345:12345"
    volumes:
      - ./alloy/config.alloy:/etc/alloy/config.alloy
    command: ["run", "/etc/alloy/config.alloy", "--server.http.listen-addr=0.0.0.0:12345"]
    depends_on:
      oracle-db:
        condition: service_healthy
      oracle-otel-exporter:
        condition: service_started
    networks:
      - oracle-demo

networks:
  oracle-demo:
    driver: bridge
