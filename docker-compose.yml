services:
  # =========================================================================
  # Grafana Alloy -- Telemetry collector
  # Scrapes Oracle metrics (native + OTel exporter) and ships to Grafana Cloud
  # =========================================================================
  alloy:
    image: grafana/alloy:v1.8.2
    container_name: demo-oracle-alloy
    restart: unless-stopped
    volumes:
      - ./alloy/config.alloy:/etc/alloy/config.alloy
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - oracle-logs:/var/log/oracle:ro
    env_file:
      - .env
    command:
      - run
      - /etc/alloy/config.alloy
      - --server.http.listen-addr=0.0.0.0:12345
      - --stability.level=generally-available
    healthcheck:
      test: ["CMD-SHELL", "bash -c 'echo > /dev/tcp/localhost/12345'"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    depends_on:
      oracle-db:
        condition: service_healthy
      oracle-otel-exporter:
        condition: service_healthy
    networks:
      - demo

  # =========================================================================
  # Oracle Database XE 21c
  # =========================================================================
  oracle-db:
    image: gvenzl/oracle-xe:21-slim
    container_name: demo-oracle-db
    restart: unless-stopped
    environment:
      ORACLE_PASSWORD: ${ORACLE_PASSWORD}
    ports:
      - "1521:1521"
    volumes:
      - ./oracle-init/init.sql:/container-entrypoint-initdb.d/init.sql
      - ./oracle-init/create_blocking.sh:/tmp/create_blocking.sh
      - oracle-logs:/opt/oracle/diag/rdbms/xe/XE/trace
    healthcheck:
      test: ["CMD", "healthcheck.sh"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 120s
    networks:
      - demo

  # =========================================================================
  # Oracle OTel Exporter -- Official Oracle observability exporter
  # Exposes Prometheus metrics at :9161/metrics with custom SQL queries
  # =========================================================================
  oracle-otel-exporter:
    image: container-registry.oracle.com/database/observability-exporter:2.2.1
    container_name: demo-oracle-otel
    restart: unless-stopped
    volumes:
      - ./exporter/config.yaml:/config.yaml
      - ./exporter/custom-metrics.toml:/custom-metrics.toml
    command: ["--config.file=/config.yaml"]
    ports:
      - "19161:9161"
    healthcheck:
      test: ["CMD-SHELL", "bash -c 'echo > /dev/tcp/localhost/9161'"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    depends_on:
      oracle-db:
        condition: service_healthy
    networks:
      - demo

volumes:
  oracle-logs:
    driver: local

networks:
  demo:
    driver: bridge
